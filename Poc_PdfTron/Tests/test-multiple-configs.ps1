# ============================================================================
# ?? ?????? ???? ?? ?????? ???????? ?????
# ============================================================================
# ????: ????? ?? ????? ????????? ?????????
# ============================================================================

param(
    [string]$BaseUrl = "http://localhost:5063",
    [string]$InputDir = "C:\Temp\Input"
)

$ErrorActionPreference = "Continue"

# ============================================================================
# ?????? ??????
# ============================================================================

$configurations = @(
    @{ Parallel = 1;  Name = "????? (??? ????????)" },
    @{ Parallel = 5;  Name = "???????? ?????" },
    @{ Parallel = 10; Name = "???????? ???????" },
    @{ Parallel = 20; Name = "???????? ?????" },
    @{ Parallel = 30; Name = "???????? ???????" }
)

Write-Host ""
Write-Host "??????????????????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "?           ?? ????? ?????? ???????? ????? - PDF Conversion API           ?" -ForegroundColor Cyan
Write-Host "??????????????????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host ""

Write-Host "?? ?????? ??????:" -ForegroundColor White
foreach ($config in $configurations) {
    Write-Host "  • $($config.Name): $($config.Parallel) ????? ??????" -ForegroundColor Gray
}
Write-Host ""

$allResults = @()

# ============================================================================
# ????? ??????
# ============================================================================

foreach ($config in $configurations) {
    Write-Host ""
    Write-Host "????????????????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
    Write-Host " ?? ????? ?????: $($config.Name) ($($config.Parallel) ??????)" -ForegroundColor White
    Write-Host "????????????????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
    Write-Host ""
    
    # ???? ??????
    & ".\test-concurrent-load.ps1" -BaseUrl $BaseUrl -InputDir $InputDir -MaxParallel $config.Parallel
    
    # ????? ???? ??? ??????
    Write-Host ""
    Write-Host "??  ????? 10 ????? ???? ?????? ????..." -ForegroundColor Yellow
    Start-Sleep -Seconds 10
}

# ============================================================================
# ?????? ??????
# ============================================================================

Write-Host ""
Write-Host "??????????????????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "?                        ?? ?????? ??????                                  ?" -ForegroundColor Cyan
Write-Host "??????????????????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host ""

$reports = Get-ChildItem -Path "." -Filter "LOAD_TEST_REPORT_*.md" | Sort-Object LastWriteTime -Descending | Select-Object -First $configurations.Count

Write-Host "????? $($reports.Count) ????? ??????" -ForegroundColor Gray
Write-Host ""
Write-Host "?????? ???? ?????, ???:" -ForegroundColor Yellow
Write-Host "  .\show-load-test-results.ps1 -ReportPath <path>" -ForegroundColor Gray
Write-Host ""
Write-Host "?????? ???? ??????:" -ForegroundColor Yellow
Write-Host "  .\show-load-test-results.ps1" -ForegroundColor Gray
Write-Host ""

Write-Host "? ?? ??????? ??????!" -ForegroundColor Green
Write-Host ""
